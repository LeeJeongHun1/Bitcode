<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.bitcode.repository.mapper.QnaMapper">
	<resultMap id="qnaMap" type="qna">
		<result column="no" property="no" />
		<result column="group_no" property="groupNo" />
		<result column="group_order" property="groupOrder" />
		<result column="depth" property="depth" />
		<result column="id" property="id" />
		<result column="language_code" property="code" />
		<result column="language_name" property="codeName" />
		<result column="title" property="title" />
		<result column="content" property="content" />
		<result column="reg_date" property="regDate" />
		<result column="view_cnt" property="viewCnt" />
		<result column="like_cnt" property="likeCnt" />
		<!-- <result column="file_no" property="fileNo" /> <result column="stsfc_code" 
			property="stsfcCode" /> <result column="file_path" property="filePath" /> 
			<result column="ori_name" property="oriName" /> <result column="system_name" 
			property="systemName" /> -->
	</resultMap>
	<select id="selectboard" parameterType="page" resultMap="qnaMap">
  		SELECT SQL_CALC_FOUND_ROWS A.* 
  		FROM (
		select q.title,q.content,q.depth,q.group_no,q.group_order,q.id,q.language_code,q.like_cnt,q.no,q.reg_date,q.stsfc_code,q.view_cnt,l.language_name
    	from tb_qna_board q
		inner
		join tb_language_code l
		on q.language_code = l.language_code 
		order
		by group_no desc, group_order asc) A 
		LIMIT #{begin},#{end} 
	</select>  
	<select id="selectBoardSearch" parameterType="search" resultMap="qnaMap">
		SELECT SQL_CALC_FOUND_ROWS A.* 
  		FROM (
		select q.title,q.content,q.depth,q.group_no,q.group_order,q.id,q.language_code,q.like_cnt,q.no,q.reg_date,q.stsfc_code,q.view_cnt,l.language_name
    	from tb_qna_board q
		inner
		join tb_language_code l
		on q.language_code = l.language_code 
		<where>
				<choose>
				<when test="type.equals('title')">
					AND q.title like concat('%',#{keyword},'%') 
				</when>
				<when test="type.equals('content')">
					AND q.content like concat('%',#{keyword},'%')
				</when>
				<when test="type.equals('writer')">
					AND q.id like concat('%',#{keyword},'%')
				</when>
				<when test="type.equals('code')">
					ANd l.language_name like concat('%',#{keyword},'%')
				</when>
			</choose>
		</where> 
 		order
		by q.group_no desc, q.group_order asc ) A 
		LIMIT #{begin},#{end} 
	
<!-- 		select *
		from tb_qna_board q
		inner
		join tb_language_code l
		on q.language_code =
		l.language_code
		where q.title like '%테%'
		and q.content like '%ㅂ%'
		order
		by group_no desc, group_order asc; -->
	</select>
	<select id="selectBoardCount" resultType="int">
	  	select count(*) 
        from tb_qna_board
	</select>
	<!-- 검색 카운트 -->
	<select id="searchBoardCount" parameterType="search" resultType="int">
	  	select count(*) 
       	from tb_qna_board q
		inner
		join tb_language_code l
		on q.language_code = l.language_code 
		<where>
				<choose>
				<when test="type.equals('title')">
					AND q.title like concat('%',#{keyword},'%') 
				</when>
				<when test="type.equals('content')">
					AND q.content like concat('%',#{keyword},'%')
				</when>
				<when test="type.equals('writer')">
					AND q.id like concat('%',#{keyword},'%')
				</when>
				<when test="type.equals('code')">
					ANd l.language_name like concat('%',#{keyword},'%')
				</when>
			</choose>
		</where> 
	</select>
	<select id="selectBoardByNo" parameterType="int" resultMap="qnaMap">
		select *
		from tb_qna_board b
		inner
		join tb_language_code c
		on
		b.language_code = c.language_code
		where b.no = #{no}
	</select>
	
	<delete id="deleteBoard" parameterType="int">
       delete 
       from tb_qna_board
	   where group_no=#{no}
	</delete>
	
	<resultMap id="fileMap" type="qnaFile">
		<result column="no" property="no" />
		<result column="file_no" property="fileNo" />
		<result column="file_path" property="filePath" />
		<result column="ori_name" property="oriName" />
		<result column="system_name" property="systemName" />
		<result column="file_size" property="fileSize" />
	</resultMap>

	<select id="selectQnaFile" parameterType="int" resultMap="fileMap">
		select
		*
		from tb_qna_file
		where no=#{no}
	</select>

	<insert id="insertBoard" parameterType="qna">
		<selectKey keyProperty="no" resultType="int" order="AFTER">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
		<!-- insert into tb_qna_board(group_no,id,language_code,title,content) 
			values((select LAST_INSERT_ID() +0 limit 1),#{id},#{code},#{title},#{content}) -->
		insert into
		tb_qna_board(group_no,id,language_code,title,content)
		values(#{no},#{id},#{code},#{title},#{content})
	</insert>

	<update id="updateGroupNo" parameterType="int">
		update tb_qna_board
		set
		group_no =#{no}
		where no=#{no}
	</update>
	<update id="updateBoard" parameterType="qna">
		update tb_qna_board
		set
		title=#{title},
		content=#{content}
		where no=#{no}
	</update>

	<!-- 파일 등록,수정 -->
	<insert id="insertQnaFile" parameterType="qnaFile">
		insert into
		tb_qna_file(no,file_path,ori_name,system_name,file_size)
		values(#{no},#{filePath},#{oriName},#{systemName},#{fileSize})
	</insert>

	<update id="updateQnaFile" parameterType="qnaFile">
		update tb_qna_file
		set
		file_path=#{filePath},
		ori_name=#{oriName},
		system_name=#{systemName},
		file_size=#{fileSize}
		where no=#{no}
	</update>
	
	<delete id="deleteQnaFile" parameterType="int">
	    delete 
        from tb_qna_file
	    where no = #{no}
	</delete>

	<!-- 답글쿼리 -->

	<update id="updateReBoard" parameterType="qna">
		update tb_qna_board
		set
		group_order = group_order +1
		where group_no = #{groupNo}
		and group_order
		&gt; #{groupOrder}
	</update>

	<insert id="insertReBoard" parameterType="qna">
		INSERT INTO
		tb_qna_board
		(group_no,group_order,depth,title,content,id,language_code)
		VALUES
		(#{groupNo}, #{groupOrder} +1, #{depth}
		+1,#{title},#{content},#{id},#{code});
	</insert>


	<!-- 댓글쿼리 -->
	<insert id="insertComment" parameterType="qnaComment">
		insert into tb_qna_comment 
       (no,id,content,group_no)
       values(
       #{no},#{id},#{content},#{groupNo})
	</insert>
</mapper>